<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User API Interface</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      h1 {
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f0f0f0;
      }
      input[type="text"],
      input[type="number"],
      input[type="email"] {
        width: 150px;
        padding: 5px;
        margin-right: 10px;
      }
      button {
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
      }
      .form-section {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        background: #fafafa;
      }
      .form-section input {
        margin-bottom: 10px;
      }
      .paging {
        margin-top: 10px;
      }
      #healthStatus {
        margin-top: 10px;
        font-weight: bold;
      }
      .error {
        color: red;
        margin-top: 10px;
      }
      .success {
        color: green;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>User Management</h1>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div>
      <label>–ò–º—è: <input type="text" id="filterName" /></label>
      <label>Email: <input type="text" id="filterEmail" /></label>
      <label>–ú–∏–Ω. –≤–æ–∑—Ä–∞—Å—Ç: <input type="number" id="filterMinAge" min="0" /></label>
      <label>–ú–∞–∫—Å. –≤–æ–∑—Ä–∞—Å—Ç: <input type="number" id="filterMaxAge" min="0" /></label>
      <button onclick="loadUsers(1)">–ü–æ–∏—Å–∫</button>
      <button onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>–ò–º—è</th>
          <th>Email</th>
          <th>–í–æ–∑—Ä–∞—Å—Ç</th>
          <th>–°–æ–∑–¥–∞–Ω</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="userTableBody"></tbody>
    </table>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="paging">
      <button onclick="changePage(currentPage - 1)" id="prevPage">–ù–∞–∑–∞–¥</button>
      <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span id="currentPageSpan">1</span> –∏–∑ <span id="totalPagesSpan">1</span></span>
      <button onclick="changePage(currentPage + 1)" id="nextPage">–í–ø–µ—Ä–µ–¥</button>
      <span style="margin-left: 20px;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="totalUsers">0</span></span>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="form-section" id="formSection">
      <h2 id="formTitle">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
      <input type="hidden" id="userId" />
      <div>
        <label>–ò–º—è: <input type="text" id="userName" required /></label>
      </div>
      <div>
        <label>Email: <input type="email" id="userEmail" required /></label>
      </div>
      <div>
        <label>–í–æ–∑—Ä–∞—Å—Ç: <input type="number" id="userAge" min="1" max="150" required /></label>
      </div>
      <button onclick="submitUser()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="resetForm()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div id="healthStatus">–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</div>
    <div id="messageBox"></div>

    <script>
      // –ò–°–ü–†–ê–í–õ–ï–ù URL - –¥–æ–±–∞–≤–ª–µ–Ω —Å–ª—ç—à –º–µ–∂–¥—É api –∏ v1
      const apiBaseUrl = "/api/v1";
      let currentPage = 1;
      const pageSize = 10;
      let totalPages = 1;

      function showMessage(message, isError = false) {
        const box = document.getElementById("messageBox");
        box.textContent = message;
        box.className = isError ? "error" : "success";
        setTimeout(() => {
          box.textContent = "";
          box.className = "";
        }, 3000);
      }

      async function checkHealth() {
        try {
          const res = await fetch("/health");
          if (res.ok) {
            const data = await res.json();
            document.getElementById("healthStatus").textContent = "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: ‚úÖ OK";
          } else {
            document.getElementById("healthStatus").textContent = "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: ‚ùå –û—à–∏–±–∫–∞";
          }
        } catch {
          document.getElementById("healthStatus").textContent = "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: ‚ö†Ô∏è –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω";
        }
      }

      async function loadUsers(page) {
        if (page < 1) return;
        currentPage = page;

        const name = document.getElementById("filterName").value.trim();
        const email = document.getElementById("filterEmail").value.trim();
        const min_age = document.getElementById("filterMinAge").value;
        const max_age = document.getElementById("filterMaxAge").value;

        // –ò–°–ü–†–ê–í–õ–ï–ù–´ –ò–ú–ï–ù–ê –ü–ê–†–ê–ú–ï–¢–†–û–í
        const params = new URLSearchParams({
          page: currentPage,
          page_size: pageSize,
        });

        if (name) params.append("name", name);
        if (email) params.append("email", email);
        if (min_age) params.append("min_age", min_age);
        if (max_age) params.append("max_age", max_age);

        try {
          const res = await fetch(`${apiBaseUrl}/users?${params.toString()}`);
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
          }
          const data = await res.json();

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
          const users = data.users || [];
          totalPages = data.total_pages || 1;
          const total = data.total || 0;

          let rows = "";
          for (const user of users) {
            const createdDate = new Date(user.created_at).toLocaleString("ru-RU");
            rows += `<tr>
              <td>${user.id}</td>
              <td>${user.name}</td>
              <td>${user.email}</td>
              <td>${user.age}</td>
              <td>${createdDate}</td>
              <td>
                <button onclick="editUser(${user.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </td>
            </tr>`;
          }

          if (rows === "") {
            rows = '<tr><td colspan="6" style="text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
          }

          document.getElementById("userTableBody").innerHTML = rows;
          document.getElementById("currentPageSpan").textContent = currentPage;
          document.getElementById("totalPagesSpan").textContent = totalPages;
          document.getElementById("totalUsers").textContent = total;

          document.getElementById("prevPage").disabled = currentPage === 1;
          document.getElementById("nextPage").disabled = currentPage >= totalPages;
        } catch (err) {
          showMessage("–û—à–∏–±–∫–∞: " + err.message, true);
          console.error(err);
        }
      }

      async function editUser(id) {
        try {
          const res = await fetch(`${apiBaseUrl}/users/${id}`);
          if (!res.ok) throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
          const user = await res.json();

          document.getElementById("userId").value = user.id;
          document.getElementById("userName").value = user.name;
          document.getElementById("userEmail").value = user.email;
          document.getElementById("userAge").value = user.age;

          document.getElementById("formTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
          document.getElementById("formSection").scrollIntoView({ behavior: "smooth" });
        } catch (err) {
          showMessage("–û—à–∏–±–∫–∞: " + err.message, true);
        }
      }

      async function deleteUser(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
        try {
          const res = await fetch(`${apiBaseUrl}/users/${id}`, {
            method: "DELETE",
          });
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
          }
          showMessage("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
          loadUsers(currentPage);
        } catch (err) {
          showMessage("–û—à–∏–±–∫–∞: " + err.message, true);
        }
      }

      async function submitUser() {
        const id = document.getElementById("userId").value;
        const name = document.getElementById("userName").value.trim();
        const email = document.getElementById("userEmail").value.trim();
        const age = parseInt(document.getElementById("userAge").value, 10);

        if (!name || !email || isNaN(age) || age < 1 || age > 150) {
          showMessage("‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", true);
          return;
        }

        const userData = { name, email, age };

        try {
          let res;
          if (id) {
            res = await fetch(`${apiBaseUrl}/users/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(userData),
            });
          } else {
            res = await fetch(`${apiBaseUrl}/users`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(userData),
            });
          }

          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
          }

          showMessage("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
          resetForm();
          loadUsers(currentPage);
        } catch (err) {
          showMessage("–û—à–∏–±–∫–∞: " + err.message, true);
        }
      }

      function resetForm() {
        document.getElementById("userId").value = "";
        document.getElementById("userName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userAge").value = "";
        document.getElementById("formTitle").textContent = "–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
      }

      function clearFilters() {
        document.getElementById("filterName").value = "";
        document.getElementById("filterEmail").value = "";
        document.getElementById("filterMinAge").value = "";
        document.getElementById("filterMaxAge").value = "";
        loadUsers(1);
      }

      function changePage(page) {
        if (page < 1 || page > totalPages) return;
        loadUsers(page);
      }
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      checkHealth();
      loadUsers(1);
      // –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      setInterval(checkHealth, 30000);
    </script>
  </body>
</html>
